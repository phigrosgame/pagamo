async function sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}

async function grab20Questions() {
    console.log('ğŸ”µ é–‹å§‹ä¸€è¼ªæµç¨‹...');
    // é»ã€Œè©³è§£ã€
    const explanationButton = Array.from(document.querySelectorAll('button')).find(btn =>
        btn.textContent.trim() === 'è©³è§£'
    );
    if (explanationButton) {
        explanationButton.click();
        console.log('âœ… é»äº†ã€Œè©³è§£ã€');
        await sleep(100);
    }

    // æŠ“å–20é¡Œ
    console.log('ğŸ“š é–‹å§‹æŠ“20é¡Œ');
    await grabQuestion();
    await sleep(100);

    for (let i = 2; i <= 20; i++) {
        const nextButton = Array.from(document.querySelectorAll('div.cursor_pointer.exam_control_list_sprite.q_btn div')).find(div =>
            div.textContent.trim() == String(i)
        );

        if (nextButton) {
            nextButton.click();
            console.log(`â¡ï¸ é»åˆ°ç¬¬ ${i} é¡Œ`);
            await sleep(10); // ç­‰ä¸€ä¸‹è¼‰å…¥

            await grabQuestion();
            await sleep(10);
        } else {
            console.log(`âš ï¸ æ‰¾ä¸åˆ°ç¬¬ ${i} é¡ŒæŒ‰éˆ•`);
        }
    }

    // æœ€å¾Œé€€å‡ºè©³è§£
    const exitButton = document.querySelector('div.explanation_panel2_sprite.btn_exit');
    if (exitButton) {
        exitButton.click();
        console.log('âœ… é€€å‡ºè©³è§£ï¼');
    }

    console.log('ğŸ ä¸€è¼ªæµç¨‹å®Œæˆï¼');
}

async function grabQuestion() {
    const div = document.querySelector('.question-iframe-container.pgo-style-question-content-wrapper-DprzUI');
    let questionText = '';
    let imgUrl = '';

    if (div) {
        questionText = div.innerHTML.replace(/<br>/g, '\n').replace(/<\/?[^>]+(>|$)/g, "").trim();
        const img = div.querySelector('img');
        if (img) {
            imgUrl = img.src;
        }
    }

    const correctOptions = [];
    const correctDivs = document.querySelectorAll('div[data-correct="true"]');
    correctDivs.forEach(option => {
        const optionText = option.querySelector('.pgo-style-selection-content-1x0d36')?.textContent.trim();
        if (optionText) {
            correctOptions.push(optionText);
        }
    });

    if (!questionText && correctOptions.length === 0) {
        console.log('âš ï¸ æ²’æœ‰æ‰¾åˆ°é¡Œç›®æˆ–ç­”æ¡ˆ');
        return;
    }

    const newResult = {
        question: {
            text: questionText,
            img: imgUrl || null
        },
        correctOptions: correctOptions.length > 0 ? correctOptions : null
    };

    let existingData = JSON.parse(localStorage.getItem('quizData'));
    if (!Array.isArray(existingData)) {
        existingData = [];
    }

    const isDuplicate = existingData.some(item =>
        item.question.text === newResult.question.text &&
        JSON.stringify(item.correctOptions) === JSON.stringify(newResult.correctOptions)
    );

    if (!isDuplicate) {
        existingData.push(newResult);
        localStorage.setItem('quizData', JSON.stringify(existingData));
        console.log('âœ… æ–°è³‡æ–™å·²å­˜å…¥ localStorage');
    } else {
        console.log('ğŸ” é‡è¤‡çš„è³‡æ–™ï¼Œä¸å­˜');
    }
}
